{% assign order = shop.orders[order.id] %}
{% assign id = order.id %}
{% assign email = order.email %}
{% assign name = order.name %}
{% assign order_name = order.name %}
{% assign order_number = order.number %}
{% assign confirmation_number = order.confirmation_number %}

{% assign created_at = order.created_at | date: "%B %d, %Y" %}
{% assign payment_terms = order.payment_terms %}
{% assign tags = order.tags | split: ", " %}

{% capture transactions_json %}
[
  {% for transaction in order.transactions %}
    {
      "id": "{{ transaction.id }}",
      "status": "{{ transaction.status }}",
      "kind": "{{ transaction.kind }}",
      "amount": "{{ transaction.amount | times: 100 }}",
      "payment_details": {
        "credit_card_company": "{{ transaction.payment_details.credit_card_company }}",
        "credit_card_last_four_digits": "{{ transaction.payment_details.credit_card_number }}"
      }
    }
    {% unless forloop.last %},{% endunless %}
  {% endfor %}
]
{% endcapture %}
debug: {{ transactions_json }}
{% assign transactions = transactions_json | parse_json %}

{% comment %} TODO
     transaction.payment_details
{% endcomment %}

{% assign tax_price = order.total_tax | times: 100 %}
{% assign tax_lines = order.tax_lines %}


{% assign customer = order.customer %}
{% capture billing_address %}
  {{ order.billing_address.first_name }} {{ order.billing_address.last_name }}
  <br/>{{ order.billing_address.address1 }}
  {{ order.billing_address.address2 }}
  <br/>{{ order.billing_address.city }}, {{ order.billing_address.province_code }} {{ order.billing_address.zip }}
  <br/>{{ order.billing_address.country }}
  
{% endcapture %}
{% assign subtotal_price = order.subtotal_price | times: 100 %}

{% comment %} TODO   
    discounts 
    discounts_amount
    discounts_savings
    total_price
    financial_status
{% endcomment %}

{% assign requires_shipping = false %}
{% for line_item in order.line_items %}
  {% if line_item.requires_shipping %}
    {% assign requires_shipping = true %}
    {% break %}
  {% endif %}{% endfor %}

{% comment %} TODO   
    shipping_method.title
    shipping_method.price
{% endcomment %}

{% assign shipping_price = order.total_shipping_price_set.shop_money.amount | times: 100 %}
{% capture shipping_address %} 
  {{ order.shipping_address.first_name }}  {{ order.shipping_address.last_name }}
  <br/>{{ order.shipping_address.address1 }}
  {{ order.shipping_address.address2 }}
  <br/>{{ order.shipping_address.city }}, {{ order.shipping_address.province_code }} {{ order.shipping_address.zip }}
  <br/>{{ order.shipping_address.country }}
{% endcapture %}

{% comment %} TODO
     Not sure how original_line_price is defined
     line_items
{% endcomment %}

{% capture subtotal_line_items_json %}
[
  {% for line_item in order.line_items %}
    {% assign product = shop.products[line_item.product_id] %}
    {% assign variant = shop.variants[line_item.variant_id] %}
    {% assign variant_image = product.images | where: "id", variant.image_id | first %}
    {% assign image = variant_image | default: product.image %}
    {
      "id": "{{ line_item.id }}",
      "title": "{{ line_item.title }}",
      "variant_id": "{{ line_item.variant_id }}",
      "product_id": "{{ line_item.product_id }}",
      "image": "{{ image.src }}",
      "quantity": {{ line_item.quantity }},
      "original_line_price": {{ line_item.price | times: line_item.quantity | times: 100 }},  
      "final_line_price": {{ line_item.price | times: line_item.quantity | times: 100 }}
    }
    {% unless forloop.last %},{% endunless %}
  {% endfor %}
]
{% endcapture %}
debug line items: {{ subtotal_line_items_json }}
{% assign subtotal_line_items = subtotal_line_items_json | parse_json %}

{% comment %} TODO   
    note
    attributes
    referring_site
    landing_site
    landing_site_ref
    cancelled
    cancelled_at
    cancel_reason
    "has_high_risks?
    (deprecated)"
    unique_gateways
    location (POS only)
    "fulfilled_line_items
    (deprecated)"
    "unfulfilled_line_items
    (deprecated)"
    b2b?
    customer_order_url
{% endcomment %}

{% assign company = order.company %}
{% assign company_location = order.company.location %}

{% assign po_number = order.po_number %}
{% assign order_status_url = order.order_status_url %}
{% assign discount_applications = order.discount_applications %}

{% assign total_tip = order.total_tip_received | plus: 0 %}
{% assign total_duties = order.current_total_duties_set.shop_money.amount %}